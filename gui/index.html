<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Lick-Hunter Bot</title>
    <link rel="stylesheet" type="text/css" href="https://www.w3schools.com/w3css/4/w3.css">
    <link class="theme" rel="stylesheet" href="https://www.w3schools.com/lib/w3-theme-black.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <link rel="stylesheet" href="/css/web.css" />
    <link rel="icon" type="image/x-icon" href="/img/icon.ico" />
  </head>
  <body class="w3-theme-l1 w3-content">
    <div class="w3-container">
      <h1 class="w3-container w3-center">
        <a class="logo" href="/"></a>
      </h1>
      <h3 class="w3-half w3-left-align">
        <a href="#" title="Dashboard"><i class="fa-solid fa-chalkboard" style="color: #800080;"></i></a>
        <a href="#" title="Settings"><i class="fa-solid fa-gear" style="color: #800080;"></i></a>
        <a href="https://github.com/CryptoGnome/Bybit-Lick-Hunter-v4" title="Github"><i class="fa-brands fa-github" style="color: #800080;"></i></a>
        <a href="https://discord.com/invite/TTn5Dxg" title="Discord"><i class="fa-brands fa-discord" style="color: #800080;"></i></a>
      </h3>
      <div class="w3-half w3-right-align" id="websoc_status"><p class="w3-text-red"><i class="fa-solid fa-signal fa-fade"></i> Websocket Disconnected</p></div>
    </div>
    <div class="w3-panel w3-leftbar w3-border-purple w3-card w3-third">
      <div class="w3-container w3-center">
        <h4>Balance</h4>
        <p id="balance"></p>
      </div>
    </div>
    <div class="w3-panel w3-leftbar w3-border-purple w3-card w3-third">
      <div class="w3-container w3-center">
        <h4>Leverage</h4>
        <p id="leverage"></p>
      </div>
    </div>
    <div class="w3-panel w3-leftbar w3-border-purple w3-card w3-third">
      <div class="w3-container w3-center">
        <h4>Total USDT in Positions</h4>
        <p id="inposi"></p>
      </div>
    </div>    
    <div class="w3-panel w3-leftbar w3-border-purple w3-card w3-half">
      <div class="w3-container w3-center">
        <h4>Profit USDT</h4>
        <p id="profitusdt"></p>
      </div>
    </div>
    <div class="w3-panel w3-leftbar w3-border-purple w3-card w3-half">
      <div class="w3-container w3-center">
        <h4>Profit %</h4>
        <p id="profit"></p>
      </div>
    </div>

    <div class="w3-row" id="openpositions"></div>

    <div class="w3-panel w3-leftbar w3-border-purple w3-card w3-row">
      <div class="w3-container w3-center">
        <p id="footer"></p>
      </div>
    </div>

    <script>

    class WebSocketClient {
      constructor() {
          const serverIp = window.location.hostname;
          this.socket = new WebSocket(`ws://${serverIp}:3000`);

          this.socket.addEventListener('open', (event) => {
            document.getElementById("websoc_status").innerHTML = '<p class="w3-text-green"><i class="fa-solid fa-signal fa-fade"></i> Websocket Connected</p>';
            console.log('WebSocket connection established.');
          });
      }

      send(data) {
          this.socket.send(data);
      }

      addEventListener(event, callback) {
          this.socket.addEventListener(event, callback);
      }
    }

    const socket = new WebSocketClient();

    socket.addEventListener('open', event => {
      document.getElementById("websoc_status").innerHTML = '<p class="w3-text-green"><i class="fa-solid fa-signal fa-fade"></i> Websocket Connected</p>';
      console.log('WebSocket-Connection OK!');
    });

    socket.addEventListener('message', event => {

      const data = JSON.parse(event.data);

      switch (data.type) {
        case 'data':
          document.getElementById("balance").textContent = data.data.balance;
          document.getElementById("leverage").textContent = data.data.leverage;
          document.getElementById("inposi").textContent = data.data.totalUSDT;
          document.getElementById("profitusdt").innerHTML = '<p style="color:' + (data.data.profitUSDT < 0 ? "red" : "green") + ';">' + data.data.profitUSDT + '</p>';
          document.getElementById("profit").innerHTML = '<p style="color:' + (data.data.profit < 0 ? "red" : "green") + ';">' + data.data.profit + '</p>';
          document.getElementById("footer").innerHTML = "Open  Positions: " + data.data.positioncount + "<br>Servertime: " + data.data.servertime;
          break;
        case 'positions':
          var posis = "";
          for (let i in data.data){
            posis += '<div class=\"w3-panel w3-leftbar w3-border-' + (data.data[i].pnl < 0 ? "red" : "green") + ' w3-card w3-third\"><div class=\"w3-container\">' +
            '<div class=\"w3-center\"><p>' + data.data[i].side + '</p> '+ data.data[i].symbol +'</div>' +
            '<p><b>Isolated:</b> <span class=\"w3-right-align\">' + data.data[i].isolated + '</span></p>' +
            '<p><b>Closing Fee:</b> <span class=\"w3-right-align\">' + data.data[i].closing_fee + '</span></p>' +
            '<p><b>Size:</b> <span class=\"w3-right-align\">' + data.data[i].size + '</span></p>' +
            '<p><b>Value in $:</b> <span class=\"w3-right-align\">' + data.data[i].sizeUSD + '</span></p>' +
            '<p><b>Liq Price:</b> <span class=\"w3-right-align\">' + data.data[i].liq_price + '</span></p>' +
            '<p><b>Price:</b> <span class=\"w3-right-align\">' + data.data[i].price + '</span></p>' +
            '<p><b>Entry Price:</b> <span class=\"w3-right-align\">' + data.data[i].entry_price + '</span></p>' +
            '<p><b>Stop Loss:</b> <span class=\"w3-right-align\">' + data.data[i].stop_loss + '</span></p>' +
            '<p><b>Take Profit:</b> <span class=\"w3-right-align\">' + data.data[i].take_profit + '</span></p>' +
            '<p><b>PnL:</b> <span class=\"w3-right-align\" style="color:' + (data.data[i].pnl < 0 ? "red" : "green") + ';">' + data.data[i].pnl + '</span></p>' +
            '</div></div>';
            i++;
          }
          if (posis != 0)
            document.getElementById("openpositions").innerHTML = posis;
          else 
            document.getElementById("openpositions").innerHTML = '<div class=\"w3-panel w3-leftbar w3-border-purple w3-card w3-row\">No open Positions</div>';
          break;
        default:
          console.warn('Unknown message: ', event.data.type);
      }
    });

    socket.addEventListener('error', event => {
      document.getElementById("websoc_status").innerHTML = '<p class="w3-text-red"><i class="fa-solid fa-signal fa-fade"></i> Websocket Disconnected</p>';
      console.error('WebSocket-Error:', event);
    });

    socket.addEventListener('close', event => {
      document.getElementById("websoc_status").innerHTML = '<p class="w3-text-red"><i class="fa-solid fa-signal fa-fade"></i> Websocket Disconnected</p>';
      console.log('WebSocket-Connection closed');
    });

    </script>
  </body>
</html>